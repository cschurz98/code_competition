<!doctype html>
<html>
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="refresh" content="0; url=./index.html" />
        <title>CodeClash â€” Redirect</title>
    </head>
    <body>
        <p>Redirecting to the modular app: <a href="./index.html">index.html</a></p>
    </body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CodeClash - Competition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="./css/styles.css" />
</head>
<body class="bg-slate-950 text-slate-200 font-sans h-screen flex flex-col overflow-hidden">
    <!-- header + main retained; JS is modular -->
    <!-- Header Section -->
    <header class="h-14 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 p-1.5 rounded-lg"><i data-lucide="code" class="w-5 h-5 text-white"></i></div>
            <h1 class="text-xl font-bold bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent">CodeClash</h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="text-right hidden sm:block">
                    <div class="text-xs text-slate-400">Current User</div>
                    <div id="username-display" class="text-xs font-bold text-white">Guest</div>
                </div>
                <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-white text-xs">G</div>
            </div>
        <!DOCTYPE html>
        <html lang="en">
            <head>
                <meta charset="utf-8" />
                <meta name="viewport" content="width=device-width, initial-scale=1.0" />
                <title>CodeClash - Competition</title>
                <script src="https://cdn.tailwindcss.com"></script>
                <script src="https://unpkg.com/lucide@latest"></script>
                <link rel="stylesheet" href="./css/styles.css" />
            </head>
            <body class="bg-slate-950 text-slate-200 font-sans h-screen flex flex-col overflow-hidden">
                <!-- Clean modular page â€” JS lives in /js -->

                <header class="h-14 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6 shrink-0">
                    <div class="flex items-center gap-2">
                        <div class="bg-indigo-600 p-1.5 rounded-lg"><i data-lucide="code" class="w-5 h-5 text-white"></i></div>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent">CodeClash</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <div class="text-right hidden sm:block"><div class="text-xs text-slate-400">Current User</div><div id="username-display" class="text-xs font-bold text-white">Guest</div></div>
                            <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-white text-xs">G</div>
                        </div>
                    </div>
                </header>

                <main class="flex-1 flex overflow-hidden">
                    <div class="w-1/3 min-w-[350px] border-r border-slate-800 flex flex-col bg-slate-900/50">
                        <div id="problem-list" class="p-4 border-b border-slate-800 overflow-x-auto whitespace-nowrap scrollbar-hide flex gap-2"></div>
                        <div class="flex-1 overflow-y-auto p-6 scrollbar-thin scrollbar-thumb-slate-700">
                            <div class="flex justify-between items-start mb-4"><h2 id="problem-title" class="text-2xl font-bold text-white">Loading...</h2><span id="problem-difficulty" class="px-2 py-0.5 rounded text-xs font-semibold"></span></div>
                            <p id="problem-desc" class="text-slate-400 leading-relaxed text-sm mb-6"></p>
                            <div class="space-y-4 mb-8"><h3 class="text-sm font-semibold text-slate-200 uppercase tracking-wider">Examples</h3><div id="example-cases" class="space-y-2"></div></div>
                            <div class="mb-6 bg-slate-900/50 rounded-lg p-4 border border-slate-800/50"><h3 class="text-xs font-bold text-slate-300 uppercase tracking-wider mb-3 flex items-center gap-2"><i data-lucide="award" class="w-4 h-4 text-indigo-400"></i>Adaptive Efficiency Scoring</h3><div class="grid grid-cols-2 gap-4 text-center mb-4"><div class="bg-slate-800/50 rounded p-2 border border-slate-700"><div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Base Score</div><div class="text-sm text-white">Points for passing checks</div></div><div class="bg-slate-800/50 rounded p-2 border border-emerald-500/20 bg-emerald-900/10"><div class="text-[10px] text-emerald-400 font-bold uppercase mb-1">Efficiency Bonus</div><div class="text-sm text-white">+50 pts for optimized code</div></div></div><p class="text-[10px] text-slate-500 leading-relaxed text-center">Scores are calculated using <strong>normalized time</strong>. We calibrate for your computer's speed so slow and fast devices can compete fairly.</p></div>
                            <div class="bg-slate-800 rounded-lg p-4 border border-slate-700"><div class="flex items-center justify-between mb-4"><h3 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="trophy" class="w-5 h-5 text-yellow-500"></i>Leaderboard</h3><div class="flex gap-1"><input type="file" id="json-input" class="hidden" accept=".json"><button id="btn-import" class="text-[10px] text-slate-300 bg-slate-700 hover:bg-slate-600 hover:text-white px-2 py-1 rounded border border-slate-600 transition-colors flex items-center gap-1" title="Load JSON"><i data-lucide="upload" class="w-3 h-3"></i> Load</button><button id="btn-export" class="text-[10px] text-slate-300 bg-slate-700 hover:bg-slate-600 hover:text-white px-2 py-1 rounded border border-slate-600 transition-colors flex items-center gap-1" title="Save JSON"><i data-lucide="download" class="w-3 h-3"></i> Save</button></div></div><div id="leaderboard-list" class="space-y-2 max-h-60 overflow-y-auto"></div></div>
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col min-w-0">
                        <div class="h-10 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 shrink-0"><div class="flex gap-4 h-full"><button id="tab-problem" class="text-xs font-medium border-b-2 h-10 px-2 text-white border-indigo-500 transition-colors">Problem</button><button id="tab-console" class="text-xs font-medium border-b-2 h-10 px-2 text-slate-500 border-transparent hover:text-slate-300 flex items-center gap-2 transition-colors">Output Console<span id="console-status-dot" class="w-1.5 h-1.5 rounded-full hidden"></span></button></div><div class="flex items-center gap-2"><button id="btn-reset" class="p-1.5 text-slate-500 hover:text-white hover:bg-slate-800 rounded transition-colors" title="Reset Code"><i data-lucide="refresh-cw" class="w-4 h-4"></i></button><button id="btn-run" class="flex items-center gap-2 px-4 py-1.5 rounded text-sm font-semibold transition-all bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-900/50"><i data-lucide="play" class="w-4 h-4 fill-current"></i><span id="btn-run-text">Run Code</span></button></div></div>
                        <div class="flex-1 relative bg-slate-900 flex flex-col">
                            <div class="flex items-center px-4 py-2 bg-slate-800 border-b border-slate-700 z-10 shrink-0"><span class="text-xs text-slate-400 font-semibold">solution.js</span><div id="status-valid" class="ml-auto flex items-center text-emerald-500 text-xs gap-1.5 opacity-50"><i data-lucide="check-circle" class="w-3 h-3"></i><span>Valid JS</span></div><div id="status-error" class="ml-auto flex items-center text-red-400 text-xs gap-1.5 animate-pulse hidden"><i data-lucide="x-circle" class="w-3 h-3"></i><span>Syntax Error</span></div></div>
                            <div class="relative flex-1 w-full h-full flex overflow-hidden"><div id="line-numbers" class="w-12 pt-4 pb-4 bg-slate-900/50 border-r border-slate-800 text-right pr-3 text-slate-600 select-none overflow-hidden code-line-height font-mono text-sm">1</div><textarea id="code-editor" class="flex-1 w-full h-full p-4 bg-slate-900 resize-none focus:outline-none focus:ring-0 text-slate-200 code-line-height font-mono whitespace-pre text-sm" spellcheck="false"></textarea><div id="syntax-error-overlay" class="absolute bottom-4 left-16 right-4 bg-red-950/95 border border-red-500/50 text-red-200 p-4 rounded-md text-xs font-mono backdrop-blur-md shadow-2xl z-20 hidden transition-all duration-300"><div class="flex items-start gap-3"><div class="bg-red-900/50 p-2 rounded text-red-400 mt-0.5"><i data-lucide="file-warning" class="w-5 h-5"></i></div><div class="flex-1"><div id="syntax-error-title" class="flex items-center gap-2 font-bold mb-1 text-red-100 uppercase tracking-wider text-[10px]">SYNTAX ERROR</div><div id="syntax-error-msg" class="text-sm font-semibold mb-2 text-white">Unexpected token</div><div class="text-red-300/70 text-[10px] border-t border-red-800/50 pt-2 mt-2">Review your code for typos, missing brackets, or invalid syntax patterns.</div></div></div></div>
                            <div id="console-panel" class="transition-all duration-300 border-t border-slate-800 bg-slate-950 h-10 flex flex-col"><div id="console-header-collapsed" class="h-10 flex items-center px-4 cursor-pointer hover:bg-slate-900 shrink-0"><i data-lucide="terminal" class="w-4 h-4 text-slate-500 mr-2"></i><span id="console-mini-status" class="text-xs text-slate-500">Console Output</span><i data-lucide="chevron-right" class="w-4 h-4 text-slate-600 ml-auto -rotate-90"></i></div>
                                <div id="console-content" class="flex-1 flex flex-col hidden h-full"><div class="h-8 bg-slate-900 px-4 flex items-center justify-between border-b border-slate-800 shrink-0"><span class="text-xs font-semibold text-slate-400 flex items-center gap-2"><i data-lucide="terminal" class="w-3 h-3"></i>Execution Results</span><span id="execution-time" class="text-xs text-indigo-400 font-mono flex items-center gap-1 hidden"><i data-lucide="zap" class="w-3 h-3"></i><span id="time-val">0ms</span></span></div><div id="console-logs" class="flex-1 overflow-y-auto p-4 font-mono text-xs space-y-3"><div class="text-slate-600 italic">Run your code to see results...</div></div></div>
                            </div>
                        </div>
                    </div>

                </main>

                <script type="module" src="./js/app.js"></script>

            </body>
        </html>
            }

            state.isRunning = true;
            updateRunButton();
            openConsole();
            els.consoleLogs.innerHTML = '';
            els.executionTime.classList.add('hidden');
            
            // 1. Calibrate before running to check current system load
            const calibration = calibrateMachine();
            state.speedFactor = calibration.factor;
            
            state.myStatus = "Running Tests...";
            updateLeaderboardUI();

            // 2. Execution Timeout to allow UI to render 'Running...' state
            setTimeout(() => {
                try {
                    const userFunc = new Function(`return ${state.code}`)();
                    const logs = [];
                    let allPassed = true;
                    
                    // 3. Run Standard Functional Test Cases
                    state.currentProblem.testCases.forEach((testCase, idx) => {
                         try {
                            const inputClone = JSON.parse(JSON.stringify(testCase.input));
                            const result = userFunc(...inputClone);
                            const passed = deepEqual(result, testCase.expected);
                            if (!passed) allPassed = false;

                            logs.push({
                                passed,
                                input: JSON.stringify(testCase.input),
                                expected: JSON.stringify(testCase.expected),
                                actual: JSON.stringify(result)
                            });
                         } catch (err) {
                             allPassed = false;
                             logs.push({ passed: false, error: err.message, input: JSON.stringify(testCase.input) });
                         }
                    });

                    // 4. Run Stress Test (Performance Benchmarking)
                    let efficiencyBonus = 0;
                    let timeComplexityLabel = "N/A";
                    let execTime = 0;
                    let normalizedTime = 0;

                    if (allPassed && state.currentProblem.stressTest) {
                        const stressData = state.currentProblem.stressTest();
                        const start = performance.now();
                        
                        // Handle batch execution vs single large input
                        if (stressData.isBatch) {
                            const batchInput = stressData.input;
                            for(let i=0; i<stressData.batchSize; i++) {
                                userFunc(...batchInput);
                            }
                        } else {
                            userFunc(...stressData.input);
                        }
                        
                        const end = performance.now();
                        execTime = end - start;
                        
                        // 5. Normalize Time based on Machine Speed
                        normalizedTime = execTime / state.speedFactor;

                        // 6. Calculate Efficiency Bonus
                        const t = state.currentProblem.baseThresholds;
                        if (normalizedTime <= t.optimal) {
                            efficiencyBonus = 50;
                            timeComplexityLabel = "Excellent (Likely O(n) or better)";
                        } else if (normalizedTime <= t.acceptable) {
                            efficiencyBonus = 20;
                            timeComplexityLabel = "Good (Likely O(n log n))";
                        } else {
                            efficiencyBonus = 0;
                            timeComplexityLabel = "Inefficient (Likely O(nÂ²) or worse)";
                        }
                    }

                    // 7. Scoring: Only update if new score is higher than previous best
                    const runScore = state.currentProblem.points + efficiencyBonus;
                    const problemId = state.currentProblem.id;
                    const previousBest = state.problemScores[problemId] || 0;
                    let isNewBest = false;

                    if (allPassed) {
                        if (runScore > previousBest) {
                            state.problemScores[problemId] = runScore;
                            isNewBest = true;
                            // Sum total score
                            state.myScore = Object.values(state.problemScores).reduce((a, b) => a + b, 0);
                            state.myStatus = `New Best! (${runScore}pts)`;
                        } else {
                            state.myStatus = `Passed (Best: ${previousBest}pts)`;
                        }
                        
                        els.consoleStatusDot.className = "w-1.5 h-1.5 rounded-full bg-emerald-500 inline-block";
                        els.consoleMiniStatus.textContent = "Console Output (Passed)";
                    } else {
                        state.myStatus = "Failed Tests";
                        els.consoleStatusDot.className = "w-1.5 h-1.5 rounded-full bg-red-500 inline-block";
                        els.consoleMiniStatus.textContent = "Console Output (Failed)";
                    }
                    
                    renderLogs(logs, allPassed, efficiencyBonus, timeComplexityLabel, execTime, normalizedTime, isNewBest, previousBest);
                    
                    els.executionTime.classList.remove('hidden');
                    els.timeVal.textContent = `${execTime.toFixed(2)}ms`;

                } catch (err) {
                    els.consoleLogs.innerHTML = `<div class="p-3 rounded border bg-red-950/30 border-red-900/50 text-red-300 font-mono text-xs">Runtime Error: ${err.message}</div>`;
                    state.myStatus = "Runtime Error";
                }

                state.isRunning = false;
                updateRunButton();
                updateLeaderboardUI();
            }, 500); // 500ms delay to visually show "Running..."
        }

        // --- CONSOLE OUTPUT RENDERING ---

        function renderLogs(logs, allPassed, bonus, complexity, rawTime, normTime, isNewBest, previousBest) {
            let html = logs.map(log => `
                <div class="p-3 rounded border ${log.passed ? 'bg-emerald-950/30 border-emerald-900/50' : 'bg-red-950/30 border-red-900/50'}">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="${log.passed ? 'check-circle' : 'x-circle'}" class="w-4 h-4 ${log.passed ? 'text-emerald-500' : 'text-red-500'}"></i>
                        <span class="${log.passed ? 'text-emerald-400' : 'text-red-400'} font-bold">
                            ${log.passed ? 'Test Passed' : 'Test Failed'}
                        </span>
                    </div>
                    ${log.error ? `<div class="text-red-300 ml-6">${log.error}</div>` : `
                    <div class="grid grid-cols-[60px_1fr] gap-y-1 ml-6">
                        <span class="text-slate-500">Input:</span>
                        <span class="text-slate-300">${log.input}</span>
                        ${!log.passed ? `
                        <span class="text-slate-500">Expected:</span>
                        <span class="text-slate-300">${log.expected}</span>
                        <span class="text-slate-500">Actual:</span>
                        <span class="text-red-300">${log.actual}</span>` : ''}
                    </div>`}
                </div>
            `).join('');

            if (allPassed) {
                const totalRunScore = state.currentProblem.points + bonus;
                const scoreMessage = isNewBest 
                    ? `<span class="text-emerald-400 font-bold">New Best Score!</span>` 
                    : `<span class="text-slate-400">Previous Best: ${previousBest} pts</span>`;
                
                const speedInfo = `Computer Speed Factor: ${state.speedFactor.toFixed(2)}x (Raw: ${rawTime.toFixed(2)}ms âž” Norm: ${normTime.toFixed(2)}ms)`;

                html += `
                <div class="mt-4 p-4 bg-slate-900 rounded border border-indigo-500/30">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="zap" class="w-4 h-4 text-yellow-400"></i>
                        <span class="font-bold text-white">Performance Analysis</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-xs font-mono">
                         <div>
                            <div class="text-slate-500">Stress Test Time</div>
                            <div class="text-slate-300" title="${speedInfo}">${normTime.toFixed(2)}ms <span class="text-slate-600">(normalized)</span></div>
                         </div>
                         <div>
                            <div class="text-slate-500">Est. Complexity</div>
                            <div class="${bonus === 50 ? 'text-emerald-400' : bonus === 20 ? 'text-yellow-400' : 'text-red-400'}">${complexity}</div>
                         </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-gradient-to-r from-emerald-900/20 to-indigo-900/20 rounded border border-emerald-500/30 text-center">
                    <h4 class="text-emerald-400 font-bold text-lg mb-1">ðŸŽ‰ Challenge Completed!</h4>
                    <p class="text-slate-400 text-sm mb-2">
                        Base: ${state.currentProblem.points} + Efficiency: <span class="text-yellow-400 font-bold">+${bonus}</span>
                    </p>
                    <div class="bg-slate-900/50 rounded p-2 inline-block border border-slate-700/50">
                        <div class="text-white font-bold text-xl">${totalRunScore} pts</div>
                        <div class="text-xs mt-1">${scoreMessage}</div>
                    </div>
                </div>`;
            }

            els.consoleLogs.innerHTML = html;
            lucide.createIcons();
        }

        function updateRunButton() {
            if (state.isRunning) {
                els.btnRun.classList.add('opacity-50', 'cursor-not-allowed');
                els.btnRunText.textContent = 'Running...';
                els.btnRunIcon.setAttribute('data-lucide', 'refresh-cw');
                els.btnRunIcon.classList.add('animate-spin');
            } else {
                els.btnRun.classList.remove('opacity-50', 'cursor-not-allowed');
                els.btnRunText.textContent = 'Run Code';
                els.btnRunIcon.setAttribute('data-lucide', 'play');
                els.btnRunIcon.classList.remove('animate-spin');
            }
            lucide.createIcons();
        }

        function setupListeners() {
            // Editor Inputs
            els.editor.addEventListener('input', handleInput);
            els.editor.addEventListener('scroll', () => {
                els.lineNumbers.scrollTop = els.editor.scrollTop;
            });

            // Action Buttons
            els.btnReset.addEventListener('click', () => {
                loadProblem(state.currentProblem);
            });

            els.btnRun.addEventListener('click', () => {
                if(!state.isRunning) runCode();
            });

            // File Handling Listeners
            els.btnExport.addEventListener('click', exportData);
            els.btnImport.addEventListener('click', () => els.jsonInput.click());
            els.jsonInput.addEventListener('change', importData);

            // Tabs / Console Toggle Logic
            const showConsole = () => {
                els.consolePanel.style.height = '16rem'; // h-64
                els.consoleHeaderCollapsed.classList.add('hidden');
                els.consoleContent.classList.remove('hidden');
                
                els.tabConsole.classList.add('text-white', 'border-indigo-500');
                els.tabConsole.classList.remove('text-slate-500', 'border-transparent');
                
                els.tabProblem.classList.remove('text-white', 'border-indigo-500');
                els.tabProblem.classList.add('text-slate-500', 'border-transparent');
            };

            const hideConsole = () => {
                els.consolePanel.style.height = '2.5rem'; // h-10
                els.consoleHeaderCollapsed.classList.remove('hidden');
                els.consoleContent.classList.add('hidden');
                
                els.tabConsole.classList.remove('text-white', 'border-indigo-500');
                els.tabConsole.classList.add('text-slate-500', 'border-transparent');
                
                els.tabProblem.classList.add('text-white', 'border-indigo-500');
                els.tabProblem.classList.remove('text-slate-500', 'border-transparent');
            };

            els.tabConsole.addEventListener('click', showConsole);
            els.consoleHeaderCollapsed.addEventListener('click', showConsole);
            els.tabProblem.addEventListener('click', hideConsole);
            
            // Expose for global usage if needed
            window.openConsole = showConsole;
        }

        // Start App
        init();

    </script>
</body>
</html>