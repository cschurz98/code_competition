<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeClash - Competition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles -->
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .code-line-height {
            line-height: 1.625;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="h-14 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-6 shrink-0">
        <div class="flex items-center gap-2">
            <div class="bg-indigo-600 p-1.5 rounded-lg">
                <i data-lucide="code" class="w-5 h-5 text-white"></i>
            </div>
            <h1 class="text-xl font-bold bg-gradient-to-r from-indigo-400 to-cyan-400 bg-clip-text text-transparent">
                CodeClash
            </h1>
        </div>
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="text-right hidden sm:block">
                    <div class="text-xs text-slate-400">Current User</div>
                    <div id="username-display" class="text-xs font-bold text-white">Guest</div>
                </div>
                <div class="w-8 h-8 rounded-full bg-indigo-500 flex items-center justify-center font-bold text-white text-xs">
                    G
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- Left Sidebar: Problem & Leaderboard -->
        <div class="w-1/3 min-w-[350px] border-r border-slate-800 flex flex-col bg-slate-900/50">
            
            <!-- Problem Selector -->
            <div id="problem-list" class="p-4 border-b border-slate-800 overflow-x-auto whitespace-nowrap scrollbar-hide flex gap-2">
                <!-- Buttons injected by JS -->
            </div>

            <div class="flex-1 overflow-y-auto p-6 scrollbar-thin scrollbar-thumb-slate-700">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="problem-title" class="text-2xl font-bold text-white">Loading...</h2>
                    <span id="problem-difficulty" class="px-2 py-0.5 rounded text-xs font-semibold"></span>
                </div>
                
                <p id="problem-desc" class="text-slate-400 leading-relaxed text-sm mb-6"></p>

                <div class="space-y-4 mb-8">
                    <h3 class="text-sm font-semibold text-slate-200 uppercase tracking-wider">Examples</h3>
                    <div id="example-cases" class="space-y-2">
                        <!-- Examples injected by JS -->
                    </div>
                </div>

                <!-- Scoring System Info -->
                <div class="mb-6 bg-slate-900/50 rounded-lg p-4 border border-slate-800/50">
                    <h3 class="text-xs font-bold text-slate-300 uppercase tracking-wider mb-3 flex items-center gap-2">
                        <i data-lucide="award" class="w-4 h-4 text-indigo-400"></i>
                        Efficiency Scoring
                    </h3>
                    <div class="grid grid-cols-2 gap-4 text-center mb-4">
                        <div class="bg-slate-800/50 rounded p-2 border border-slate-700">
                            <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Base Score</div>
                            <div class="text-sm text-white">Points for passing checks</div>
                        </div>
                        <div class="bg-slate-800/50 rounded p-2 border border-emerald-500/20 bg-emerald-900/10">
                            <div class="text-[10px] text-emerald-400 font-bold uppercase mb-1">Efficiency Bonus</div>
                            <div class="text-sm text-white">+50 pts for O(n) or better</div>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-500 leading-relaxed text-center">
                        Code is benchmarked against large inputs. Efficient algorithms (low Big O complexity) earn significantly more points.
                    </p>
                </div>

                <!-- Leaderboard with File Controls -->
                <div class="bg-slate-800 rounded-lg p-4 border border-slate-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i data-lucide="trophy" class="w-5 h-5 text-yellow-500"></i>
                            Leaderboard
                        </h3>
                        <!-- Import/Export Controls -->
                        <div class="flex gap-1">
                             <input type="file" id="json-input" class="hidden" accept=".json">
                             <button id="btn-import" class="text-[10px] text-slate-300 bg-slate-700 hover:bg-slate-600 hover:text-white px-2 py-1 rounded border border-slate-600 transition-colors flex items-center gap-1" title="Load JSON">
                                <i data-lucide="upload" class="w-3 h-3"></i> Load
                             </button>
                             <button id="btn-export" class="text-[10px] text-slate-300 bg-slate-700 hover:bg-slate-600 hover:text-white px-2 py-1 rounded border border-slate-600 transition-colors flex items-center gap-1" title="Save JSON">
                                <i data-lucide="download" class="w-3 h-3"></i> Save
                             </button>
                        </div>
                    </div>
                    
                    <div id="leaderboard-list" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Leaderboard items -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Content: Editor & Console -->
        <div class="flex-1 flex flex-col min-w-0">
            
            <!-- Toolbar -->
            <div class="h-10 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 shrink-0">
                <div class="flex gap-4 h-full">
                    <button id="tab-problem" class="text-xs font-medium border-b-2 h-10 px-2 text-white border-indigo-500 transition-colors">
                        Problem
                    </button>
                    <button id="tab-console" class="text-xs font-medium border-b-2 h-10 px-2 text-slate-500 border-transparent hover:text-slate-300 flex items-center gap-2 transition-colors">
                        Output Console
                        <span id="console-status-dot" class="w-1.5 h-1.5 rounded-full hidden"></span>
                    </button>
                </div>
                
                <div class="flex items-center gap-2">
                    <button id="btn-reset" class="p-1.5 text-slate-500 hover:text-white hover:bg-slate-800 rounded transition-colors" title="Reset Code">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    </button>
                    <button id="btn-run" class="flex items-center gap-2 px-4 py-1.5 rounded text-sm font-semibold transition-all bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-900/50">
                        <i data-lucide="play" class="w-4 h-4 fill-current"></i>
                        <span id="btn-run-text">Run Code</span>
                    </button>
                </div>
            </div>

            <!-- Editor Area -->
            <div class="flex-1 relative bg-slate-900 flex flex-col">
                <!-- Editor Header -->
                <div class="flex items-center px-4 py-2 bg-slate-800 border-b border-slate-700 z-10 shrink-0">
                    <span class="text-xs text-slate-400 font-semibold">solution.js</span>
                    
                    <div id="status-valid" class="ml-auto flex items-center text-emerald-500 text-xs gap-1.5 opacity-50">
                        <i data-lucide="check-circle" class="w-3 h-3"></i>
                        <span>Valid JS</span>
                    </div>
                    <div id="status-error" class="ml-auto flex items-center text-red-400 text-xs gap-1.5 animate-pulse hidden">
                        <i data-lucide="x-circle" class="w-3 h-3"></i>
                        <span>Syntax Error</span>
                    </div>
                </div>

                <!-- Editor Body -->
                <div class="relative flex-1 w-full h-full flex overflow-hidden">
                    <!-- Line Numbers -->
                    <div id="line-numbers" class="w-12 pt-4 pb-4 bg-slate-900/50 border-r border-slate-800 text-right pr-3 text-slate-600 select-none overflow-hidden code-line-height font-mono text-sm">
                        1
                    </div>

                    <!-- Text Area -->
                    <textarea 
                        id="code-editor" 
                        class="flex-1 w-full h-full p-4 bg-slate-900 resize-none focus:outline-none focus:ring-0 text-slate-200 code-line-height font-mono whitespace-pre text-sm"
                        spellcheck="false"
                    ></textarea>

                    <!-- Syntax Error Overlay -->
                    <div id="syntax-error-overlay" class="absolute bottom-4 left-16 right-4 bg-red-950/95 border border-red-500/50 text-red-200 p-4 rounded-md text-xs font-mono backdrop-blur-md shadow-2xl z-20 hidden transition-all duration-300">
                        <div class="flex items-start gap-3">
                            <div class="bg-red-900/50 p-2 rounded text-red-400 mt-0.5">
                                <i data-lucide="file-warning" class="w-5 h-5"></i>
                            </div>
                            <div class="flex-1">
                                <div id="syntax-error-title" class="flex items-center gap-2 font-bold mb-1 text-red-100 uppercase tracking-wider text-[10px]">
                                    SYNTAX ERROR
                                </div>
                                <div id="syntax-error-msg" class="text-sm font-semibold mb-2 text-white">
                                    Unexpected token
                                </div>
                                <div class="text-red-300/70 text-[10px] border-t border-red-800/50 pt-2 mt-2">
                                    Review your code for typos, missing brackets, or invalid syntax patterns.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Console / Output Area -->
            <div id="console-panel" class="transition-all duration-300 border-t border-slate-800 bg-slate-950 h-10 flex flex-col">
                <!-- Collapsed Header -->
                <div id="console-header-collapsed" class="h-10 flex items-center px-4 cursor-pointer hover:bg-slate-900 shrink-0">
                    <i data-lucide="terminal" class="w-4 h-4 text-slate-500 mr-2"></i>
                    <span id="console-mini-status" class="text-xs text-slate-500">Console Output</span>
                    <i data-lucide="chevron-right" class="w-4 h-4 text-slate-600 ml-auto -rotate-90"></i>
                </div>

                <!-- Expanded Content -->
                <div id="console-content" class="flex-1 flex flex-col hidden h-full">
                    <div class="h-8 bg-slate-900 px-4 flex items-center justify-between border-b border-slate-800 shrink-0">
                        <span class="text-xs font-semibold text-slate-400 flex items-center gap-2">
                            <i data-lucide="terminal" class="w-3 h-3"></i>
                            Execution Results
                        </span>
                        <span id="execution-time" class="text-xs text-indigo-400 font-mono flex items-center gap-1 hidden">
                            <i data-lucide="zap" class="w-3 h-3"></i>
                            <span id="time-val">0ms</span>
                        </span>
                    </div>
                    <div id="console-logs" class="flex-1 overflow-y-auto p-4 font-mono text-xs space-y-3">
                        <div class="text-slate-600 italic">Run your code to see results...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- App Logic -->
    <script>
        // --- CONSTANTS & PROBLEMS ---
        const PROBLEMS = [
            {
                id: 1,
                title: "The Classic Two Sum",
                difficulty: "Easy",
                points: 100,
                description: "Given an array of integers `nums` and an integer `target`, return indices of the two numbers such that they add up to `target`. You may assume that each input would have exactly one solution.",
                starterCode: `function twoSum(nums, target) {
  // Write your code here
  // Return an array [index1, index2]
  for (let i = 0; i < nums.length; i++) {
    for (let j = i + 1; j < nums.length; j++) {
      if (nums[i] + nums[j] === target) {
        return [i, j];
      }
    }
  }
}`,
                testCases: [
                    { input: [[2, 7, 11, 15], 9], expected: [0, 1] },
                    { input: [[3, 2, 4], 6], expected: [1, 2] },
                    { input: [[3, 3], 6], expected: [0, 1] }
                ],
                // Generates a large dataset to differentiate O(n) from O(n^2)
                stressTest: () => {
                    const size = 2000;
                    const nums = Array.from({length: size}, (_, i) => i);
                    const target = size * 2; // Won't find until very end if constructed poorly, or not at all
                    // Make it solveable at the very end to force worst case
                    nums[size-2] = 5000;
                    nums[size-1] = 5001;
                    return { input: [nums, 10001], expected: [size-2, size-1] };
                },
                timeThresholds: { optimal: 2, acceptable: 15 } // ms
            },
            {
                id: 2,
                title: "Palindrome Check",
                difficulty: "Medium",
                points: 200,
                description: "Given an integer x, return true if x is a palindrome integer. An integer is a palindrome when it reads the same backward as forward.",
                starterCode: `function isPalindrome(x) {
  // Convert to string or use math
  // Return true or false
  
}`,
                testCases: [
                    { input: [121], expected: true },
                    { input: [-121], expected: false },
                    { input: [10], expected: false }
                ],
                stressTest: () => {
                    // Test on a batch of operations rather than one big number
                    return { 
                        input: [123456789], 
                        expected: false,
                        isBatch: true, // Internal flag to run 50k times
                        batchSize: 50000 
                    };
                },
                timeThresholds: { optimal: 10, acceptable: 40 }
            },
            {
                id: 3,
                title: "FizzBuzz Architect",
                difficulty: "Hard",
                points: 300,
                description: "Return an array of strings from 1 to n. For multiples of 3 return 'Fizz', for 5 return 'Buzz', for both return 'FizzBuzz'.",
                starterCode: `function fizzBuzz(n) {
  // Return an array of strings
  
}`,
                testCases: [
                    { input: [3], expected: ["1","2","Fizz"] },
                    { input: [5], expected: ["1","2","Fizz","4","Buzz"] }
                ],
                stressTest: () => {
                    return { input: [50000], expected: null, checkOutput: (res) => res.length === 50000 && res[14] === "FizzBuzz" };
                },
                timeThresholds: { optimal: 15, acceptable: 50 }
            }
        ];

        // --- STATE MANAGEMENT ---
        const state = {
            currentProblem: PROBLEMS[0],
            code: PROBLEMS[0].starterCode,
            myScore: 0,
            problemScores: {}, // New: Tracks best score per problem ID { 1: 100, 2: 250 }
            myStatus: "Coding...",
            isRunning: false,
            syntaxError: null,
            leaderboardData: [] 
        };

        // --- DOM ELEMENTS ---
        const els = {
            editor: document.getElementById('code-editor'),
            lineNumbers: document.getElementById('line-numbers'),
            btnRun: document.getElementById('btn-run'),
            btnRunText: document.getElementById('btn-run-text'),
            btnRunIcon: document.querySelector('#btn-run i'),
            btnReset: document.getElementById('btn-reset'),
            btnImport: document.getElementById('btn-import'),
            btnExport: document.getElementById('btn-export'),
            jsonInput: document.getElementById('json-input'),
            problemList: document.getElementById('problem-list'),
            problemTitle: document.getElementById('problem-title'),
            problemDesc: document.getElementById('problem-desc'),
            problemDifficulty: document.getElementById('problem-difficulty'),
            exampleCases: document.getElementById('example-cases'),
            leaderboard: document.getElementById('leaderboard-list'),
            statusValid: document.getElementById('status-valid'),
            statusError: document.getElementById('status-error'),
            syntaxOverlay: document.getElementById('syntax-error-overlay'),
            syntaxTitle: document.getElementById('syntax-error-title'),
            syntaxMsg: document.getElementById('syntax-error-msg'),
            consolePanel: document.getElementById('console-panel'),
            consoleHeaderCollapsed: document.getElementById('console-header-collapsed'),
            consoleContent: document.getElementById('console-content'),
            consoleLogs: document.getElementById('console-logs'),
            executionTime: document.getElementById('execution-time'),
            timeVal: document.getElementById('time-val'),
            tabProblem: document.getElementById('tab-problem'),
            tabConsole: document.getElementById('tab-console'),
            consoleStatusDot: document.getElementById('console-status-dot'),
            consoleMiniStatus: document.getElementById('console-mini-status'),
            usernameDisplay: document.getElementById('username-display')
        };

        // --- UTILS ---
        const deepEqual = (x, y) => {
            if (x === y) return true;
            if ((typeof x == "object" && x != null) && (typeof y == "object" && y != null)) {
                if (Object.keys(x).length !== Object.keys(y).length) return false;
                for (var prop in x) {
                    if (y.hasOwnProperty(prop)) {
                        if (!deepEqual(x[prop], y[prop])) return false;
                    } else return false;
                }
                return true;
            }
            return false;
        };

        // --- FILE HANDLING & LEADERBOARD LOGIC ---

        function updateLeaderboardUI() {
            const displayList = [...state.leaderboardData];
            
            if (state.myScore >= 0) {
                 displayList.push({
                     name: "You (Current Session)",
                     score: state.myScore,
                     status: state.myStatus,
                     isMe: true
                 });
            }

            displayList.sort((a, b) => b.score - a.score);

            if (displayList.length === 0) {
                els.leaderboard.innerHTML = `<div class="text-slate-500 text-sm italic">No records. Play and save your score!</div>`;
                return;
            }
            
            els.leaderboard.innerHTML = displayList.map((p, idx) => {
                const isMe = p.isMe;
                return `
                <div class="flex items-center justify-between p-2 rounded ${isMe ? 'bg-indigo-900/50 border border-indigo-500/50' : 'bg-slate-700/30'}">
                    <div class="flex items-center gap-3">
                        <span class="font-mono text-sm w-4 ${idx < 3 ? 'text-yellow-400 font-bold' : 'text-slate-500'}">#${idx + 1}</span>
                        <span class="text-sm ${isMe ? 'text-indigo-300 font-semibold' : 'text-slate-300'}">
                            ${p.name}
                        </span>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-mono text-emerald-400">${p.score} pts</div>
                        <div class="text-xs text-slate-500 truncate max-w-[100px]">${p.status || '-'}</div>
                    </div>
                </div>
            `}).join('');
            
            lucide.createIcons();
        }

        function exportData() {
            const name = prompt("Enter your name to save with your score:", "Player 1");
            if (!name) return;

            const myRecord = {
                name: name,
                score: state.myScore,
                status: "Saved: " + new Date().toLocaleTimeString(),
                timestamp: Date.now()
            };
            
            els.usernameDisplay.textContent = name;

            const dataToSave = [...state.leaderboardData, myRecord];
            dataToSave.sort((a,b) => b.score - a.score);

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(dataToSave, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "codeclash_leaderboard.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
            
            state.leaderboardData = dataToSave;
            updateLeaderboardUI();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (Array.isArray(loadedData)) {
                        state.leaderboardData = loadedData;
                        updateLeaderboardUI();
                        alert("Leaderboard loaded successfully!");
                    } else {
                        alert("Invalid JSON format: Expected an array.");
                    }
                } catch (err) {
                    alert("Error reading file: " + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        // --- APP LOGIC ---

        function init() {
            renderProblemList();
            loadProblem(PROBLEMS[0]);
            setupListeners();
            updateLeaderboardUI();
            lucide.createIcons();
        }

        // --- RENDERERS ---

        function renderProblemList() {
            els.problemList.innerHTML = PROBLEMS.map(p => `
                <button 
                    onclick="window.switchProblem(${p.id})"
                    class="px-3 py-1.5 rounded-md text-xs font-medium transition-colors ${state.currentProblem.id === p.id ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}"
                    id="prob-btn-${p.id}"
                >
                    ${p.id}. ${p.title}
                </button>
            `).join('');
        }

        window.switchProblem = (id) => {
            const prob = PROBLEMS.find(p => p.id === id);
            if(prob) loadProblem(prob);
        };

        function loadProblem(problem) {
            state.currentProblem = problem;
            state.code = problem.starterCode;
            state.syntaxError = null;
            
            // Update UI
            els.editor.value = state.code;
            updateLineNumbers();
            renderProblemList(); 
            
            els.problemTitle.textContent = problem.title;
            els.problemDesc.textContent = problem.description;
            
            els.problemDifficulty.textContent = problem.difficulty;
            els.problemDifficulty.className = `px-2 py-0.5 rounded text-xs font-semibold ${
                problem.difficulty === 'Easy' ? 'bg-emerald-500/10 text-emerald-400' :
                problem.difficulty === 'Medium' ? 'bg-yellow-500/10 text-yellow-400' :
                'bg-red-500/10 text-red-400'
            }`;

            els.exampleCases.innerHTML = problem.testCases.slice(0, 2).map(tc => `
                <div class="bg-slate-950 rounded-lg p-3 border border-slate-800 font-mono text-xs">
                    <div class="mb-1"><span class="text-slate-500">Input:</span> <span class="text-indigo-300">${JSON.stringify(tc.input)}</span></div>
                    <div><span class="text-slate-500">Output:</span> <span class="text-emerald-300">${JSON.stringify(tc.expected)}</span></div>
                </div>
            `).join('');
            
            els.consoleLogs.innerHTML = `<div class="text-slate-600 italic">Run your code to see results...</div>`;
            updateSyntaxUI();
        }

        // --- EDITOR LOGIC ---

        function updateLineNumbers() {
            const lines = els.editor.value.split('\n').length;
            els.lineNumbers.innerHTML = Array.from({length: lines}, (_, i) => `<div>${i + 1}</div>`).join('');
        }

        let debounceTimer;
        function handleInput() {
            state.code = els.editor.value;
            updateLineNumbers();

            // Syntax Check
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                try {
                    new Function(state.code);
                    state.syntaxError = null;
                } catch (err) {
                    state.syntaxError = { message: err.message, name: err.name };
                }
                updateSyntaxUI();
            }, 600);
        }

        function updateSyntaxUI() {
            if (state.syntaxError) {
                els.statusValid.classList.add('hidden');
                els.statusError.classList.remove('hidden');
                els.syntaxOverlay.classList.remove('hidden');
                els.syntaxMsg.textContent = state.syntaxError.message;
                els.syntaxTitle.textContent = state.syntaxError.name || "SYNTAX ERROR";
            } else {
                els.statusValid.classList.remove('hidden');
                els.statusError.classList.add('hidden');
                els.syntaxOverlay.classList.add('hidden');
            }
        }

        // --- EXECUTION LOGIC ---

        async function runCode() {
            if (state.syntaxError) {
                openConsole();
                els.consoleLogs.innerHTML = `<div class="p-3 rounded border bg-red-950/30 border-red-900/50 text-red-300 font-mono text-xs">Cannot run code with syntax errors.</div>`;
                return;
            }

            state.isRunning = true;
            updateRunButton();
            openConsole();
            els.consoleLogs.innerHTML = '';
            els.executionTime.classList.add('hidden');
            
            state.myStatus = "Running Tests...";
            updateLeaderboardUI();

            setTimeout(() => {
                try {
                    const userFunc = new Function(`return ${state.code}`)();
                    const logs = [];
                    let allPassed = true;
                    
                    // 1. Run Standard Test Cases
                    state.currentProblem.testCases.forEach((testCase, idx) => {
                         try {
                            const inputClone = JSON.parse(JSON.stringify(testCase.input));
                            const result = userFunc(...inputClone);
                            const passed = deepEqual(result, testCase.expected);
                            if (!passed) allPassed = false;

                            logs.push({
                                passed,
                                input: JSON.stringify(testCase.input),
                                expected: JSON.stringify(testCase.expected),
                                actual: JSON.stringify(result)
                            });
                         } catch (err) {
                             allPassed = false;
                             logs.push({ passed: false, error: err.message, input: JSON.stringify(testCase.input) });
                         }
                    });

                    // 2. Run Stress Test for Efficiency (Only if Passed)
                    let efficiencyBonus = 0;
                    let timeComplexityLabel = "N/A";
                    let execTime = 0;

                    if (allPassed && state.currentProblem.stressTest) {
                        const stressData = state.currentProblem.stressTest();
                        const start = performance.now();
                        
                        if (stressData.isBatch) {
                            // Run the function many times
                            const batchInput = stressData.input;
                            for(let i=0; i<stressData.batchSize; i++) {
                                userFunc(...batchInput);
                            }
                        } else {
                            // Run once on big data
                            userFunc(...stressData.input);
                        }
                        
                        const end = performance.now();
                        execTime = end - start;

                        // Efficiency Scoring Logic
                        const t = state.currentProblem.timeThresholds;
                        if (execTime <= t.optimal) {
                            efficiencyBonus = 50;
                            timeComplexityLabel = "Excellent (Likely O(n) or better)";
                        } else if (execTime <= t.acceptable) {
                            efficiencyBonus = 20;
                            timeComplexityLabel = "Good (Likely O(n log n))";
                        } else {
                            efficiencyBonus = 0;
                            timeComplexityLabel = "Inefficient (Likely O(nÂ²) or worse)";
                        }
                    }

                    // Calculate potential score for this run
                    const runScore = state.currentProblem.points + efficiencyBonus;
                    const problemId = state.currentProblem.id;
                    const previousBest = state.problemScores[problemId] || 0;
                    let isNewBest = false;

                    if (allPassed) {
                        if (runScore > previousBest) {
                            // New High Score for this problem
                            state.problemScores[problemId] = runScore;
                            isNewBest = true;
                            // Recalculate total score
                            state.myScore = Object.values(state.problemScores).reduce((a, b) => a + b, 0);
                            state.myStatus = `New Best! (${runScore}pts)`;
                        } else {
                            // Previous score was better or equal
                            state.myStatus = `Passed (Best: ${previousBest}pts)`;
                        }
                        
                        els.consoleStatusDot.className = "w-1.5 h-1.5 rounded-full bg-emerald-500 inline-block";
                        els.consoleMiniStatus.textContent = "Console Output (Passed)";
                    } else {
                        state.myStatus = "Failed Tests";
                        els.consoleStatusDot.className = "w-1.5 h-1.5 rounded-full bg-red-500 inline-block";
                        els.consoleMiniStatus.textContent = "Console Output (Failed)";
                    }
                    
                    renderLogs(logs, allPassed, efficiencyBonus, timeComplexityLabel, execTime, isNewBest, previousBest);
                    
                    els.executionTime.classList.remove('hidden');
                    els.timeVal.textContent = `${execTime.toFixed(2)}ms (Stress Test)`;

                } catch (err) {
                    els.consoleLogs.innerHTML = `<div class="p-3 rounded border bg-red-950/30 border-red-900/50 text-red-300 font-mono text-xs">Runtime Error: ${err.message}</div>`;
                    state.myStatus = "Runtime Error";
                }

                state.isRunning = false;
                updateRunButton();
                updateLeaderboardUI();
            }, 500);
        }

        function renderLogs(logs, allPassed, bonus, complexity, time, isNewBest, previousBest) {
            let html = logs.map(log => `
                <div class="p-3 rounded border ${log.passed ? 'bg-emerald-950/30 border-emerald-900/50' : 'bg-red-950/30 border-red-900/50'}">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="${log.passed ? 'check-circle' : 'x-circle'}" class="w-4 h-4 ${log.passed ? 'text-emerald-500' : 'text-red-500'}"></i>
                        <span class="${log.passed ? 'text-emerald-400' : 'text-red-400'} font-bold">
                            ${log.passed ? 'Test Passed' : 'Test Failed'}
                        </span>
                    </div>
                    ${log.error ? `<div class="text-red-300 ml-6">${log.error}</div>` : `
                    <div class="grid grid-cols-[60px_1fr] gap-y-1 ml-6">
                        <span class="text-slate-500">Input:</span>
                        <span class="text-slate-300">${log.input}</span>
                        ${!log.passed ? `
                        <span class="text-slate-500">Expected:</span>
                        <span class="text-slate-300">${log.expected}</span>
                        <span class="text-slate-500">Actual:</span>
                        <span class="text-red-300">${log.actual}</span>` : ''}
                    </div>`}
                </div>
            `).join('');

            if (allPassed) {
                const totalRunScore = state.currentProblem.points + bonus;
                const scoreMessage = isNewBest 
                    ? `<span class="text-emerald-400 font-bold">New Best Score!</span>` 
                    : `<span class="text-slate-400">Previous Best: ${previousBest} pts</span>`;

                html += `
                <div class="mt-4 p-4 bg-slate-900 rounded border border-indigo-500/30">
                    <div class="flex items-center gap-2 mb-2">
                        <i data-lucide="zap" class="w-4 h-4 text-yellow-400"></i>
                        <span class="font-bold text-white">Performance Analysis</span>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-xs font-mono">
                         <div>
                            <div class="text-slate-500">Stress Test Time</div>
                            <div class="text-slate-300">${time.toFixed(2)}ms</div>
                         </div>
                         <div>
                            <div class="text-slate-500">Est. Complexity</div>
                            <div class="${bonus === 50 ? 'text-emerald-400' : bonus === 20 ? 'text-yellow-400' : 'text-red-400'}">${complexity}</div>
                         </div>
                    </div>
                </div>

                <div class="mt-4 p-4 bg-gradient-to-r from-emerald-900/20 to-indigo-900/20 rounded border border-emerald-500/30 text-center">
                    <h4 class="text-emerald-400 font-bold text-lg mb-1">ðŸŽ‰ Challenge Completed!</h4>
                    <p class="text-slate-400 text-sm mb-2">
                        Base: ${state.currentProblem.points} + Efficiency: <span class="text-yellow-400 font-bold">+${bonus}</span>
                    </p>
                    <div class="bg-slate-900/50 rounded p-2 inline-block border border-slate-700/50">
                        <div class="text-white font-bold text-xl">${totalRunScore} pts</div>
                        <div class="text-xs mt-1">${scoreMessage}</div>
                    </div>
                </div>`;
            }

            els.consoleLogs.innerHTML = html;
            lucide.createIcons();
        }

        function updateRunButton() {
            if (state.isRunning) {
                els.btnRun.classList.add('opacity-50', 'cursor-not-allowed');
                els.btnRunText.textContent = 'Running...';
                els.btnRunIcon.setAttribute('data-lucide', 'refresh-cw');
                els.btnRunIcon.classList.add('animate-spin');
            } else {
                els.btnRun.classList.remove('opacity-50', 'cursor-not-allowed');
                els.btnRunText.textContent = 'Run Code';
                els.btnRunIcon.setAttribute('data-lucide', 'play');
                els.btnRunIcon.classList.remove('animate-spin');
            }
            lucide.createIcons();
        }

        function setupListeners() {
            els.editor.addEventListener('input', handleInput);
            els.editor.addEventListener('scroll', () => {
                els.lineNumbers.scrollTop = els.editor.scrollTop;
            });

            els.btnReset.addEventListener('click', () => {
                loadProblem(state.currentProblem);
            });

            els.btnRun.addEventListener('click', () => {
                if(!state.isRunning) runCode();
            });

            // New: File Handling Listeners
            els.btnExport.addEventListener('click', exportData);
            els.btnImport.addEventListener('click', () => els.jsonInput.click());
            els.jsonInput.addEventListener('change', importData);

            // Tabs / Console Toggle
            const showConsole = () => {
                els.consolePanel.style.height = '16rem'; // h-64
                els.consoleHeaderCollapsed.classList.add('hidden');
                els.consoleContent.classList.remove('hidden');
                
                els.tabConsole.classList.add('text-white', 'border-indigo-500');
                els.tabConsole.classList.remove('text-slate-500', 'border-transparent');
                
                els.tabProblem.classList.remove('text-white', 'border-indigo-500');
                els.tabProblem.classList.add('text-slate-500', 'border-transparent');
            };

            const hideConsole = () => {
                els.consolePanel.style.height = '2.5rem'; // h-10
                els.consoleHeaderCollapsed.classList.remove('hidden');
                els.consoleContent.classList.add('hidden');
                
                els.tabConsole.classList.remove('text-white', 'border-indigo-500');
                els.tabConsole.classList.add('text-slate-500', 'border-transparent');
                
                els.tabProblem.classList.add('text-white', 'border-indigo-500');
                els.tabProblem.classList.remove('text-slate-500', 'border-transparent');
            };

            els.tabConsole.addEventListener('click', showConsole);
            els.consoleHeaderCollapsed.addEventListener('click', showConsole);
            els.tabProblem.addEventListener('click', hideConsole);
            
            // Expose for global usage
            window.openConsole = showConsole;
        }

        // Start
        init();

    </script>
</body>
</html>